{{!-- Partial: productList.hbs
     Expects `products` and `user` in the template context. --}}

{{#if products}}
  {{#if (eq user.role 'vendor')}}
    <h5>Mis productos</h5>
  {{else}}
    <h5>Productos disponibles</h5>
  {{/if}}

  {{#if products.length}}
    <div class="row row-cols-1 row-cols-md-2 g-3 mb-3">
      {{#each products}}
        <div class="col">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">{{this.title}}</h5>
                <small class="text-muted">{{this.price}} USD</small>
              </div>
              <p class="card-text small text-muted">Código: {{this.code}} · Stock: {{this.stock}}</p>
              <p class="card-text">{{this.description}}</p>

              <div class="mt-auto d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group" aria-label="quantity-group">
                  <button type="button" class="btn btn-outline-secondary btn-decrease" data-product-id="{{this._id}}">−</button>
                  <button type="button" class="btn btn-outline-secondary btn-qty" data-product-id="{{this._id}}">0</button>
                  <button type="button" class="btn btn-outline-secondary btn-increase" data-product-id="{{this._id}}">+</button>
                </div>

                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-primary btn-add-cart" data-product-id="{{this._id}}">Agregar al carrito</button>
                  <a href="/products/{{this._id}}" class="btn btn-sm btn-outline-primary">Ver</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {{/each}}
    </div>
  {{else}}
    {{#if (eq user.role 'vendor')}}
      <p class="text-muted">No tiene productos creados aún.</p>
    {{else}}
      <p class="text-muted">No hay productos disponibles en este momento.</p>
    {{/if}}
  {{/if}}
{{/if}}

<script>
  // Client-side cart helpers for product list
  async function fetchJson(url, opts){
    const res = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts));
    if (!res.ok) throw new Error('Request failed: ' + res.status);
    return res.json();
  }

  async function getCart(){
    try {
      return await fetchJson('/api/carts/me', { method: 'GET' });
    } catch (e) {
      return null;
    }
  }

  async function updateCart(items){
    // items: [{ product, quantity }]
    return fetchJson('/api/carts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
  }

  function normalizeProductId(p){ return (typeof p === 'string') ? p : (p._id || p.id || p.product || ''); }

  async function syncQtyDisplays(){
    const cart = await getCart();
    const map = new Map();
    if (cart && Array.isArray(cart.products)){
      cart.products.forEach(it => map.set(normalizeProductId(it.product).toString(), it.quantity));
    }
    document.querySelectorAll('.btn-qty').forEach(b => {
      const id = b.dataset.productId;
      b.textContent = map.get(id) || 0;
    });
  }

  document.addEventListener('click', async (e) => {
    const dec = e.target.closest('.btn-decrease');
    const inc = e.target.closest('.btn-increase');
    const add = e.target.closest('.btn-add-cart');
    if (!dec && !inc && !add) return;
    e.preventDefault();

    // ensure user logged in - try to fetch current session
    let sessionOk = true;
    try {
      const cur = await fetch('/api/sessions/current', { credentials: 'same-origin' });
      if (!cur.ok) sessionOk = false;
    } catch (err) { sessionOk = false; }
    if (!sessionOk) return window.location.href = '/login';

    const target = dec || inc || add;
    const pid = target.dataset.productId;
    // build updated items from current cart
    const cart = await getCart();
    const items = [];
    if (cart && Array.isArray(cart.products)){
      for (const it of cart.products){
        const prodId = normalizeProductId(it.product).toString();
        items.push({ product: prodId, quantity: it.quantity });
      }
    }

    const idx = items.findIndex(i => i.product.toString() === pid.toString());
    if (dec){
      if (idx >= 0) items[idx].quantity = Math.max(0, items[idx].quantity - 1);
    } else if (inc){
      if (idx >= 0) items[idx].quantity = items[idx].quantity + 1;
      else items.push({ product: pid, quantity: 1 });
    } else if (add){
      if (idx >= 0) items[idx].quantity = items[idx].quantity + 1;
      else items.push({ product: pid, quantity: 1 });
    }

    // remove zero-quantity items
    const cleaned = items.filter(i => i.quantity > 0);
    try {
      await updateCart(cleaned);
      await syncQtyDisplays();
    } catch (err) {
      console.error('Cart update failed', err);
      alert('No se pudo actualizar el carrito');
    }
  });

  // initial sync on load
  (function(){ syncQtyDisplays().catch(()=>{}); })();
</script>
