{{!-- Order detail view --}}
<div class="card shadow-sm">
  <div class="card-body">
    <h3 class="mb-3">Orden</h3>
    <div id="orderContainer">
      <div class="text-center py-5 text-muted">Cargando orden...</div>
    </div>
  </div>
</div>

<template id="orderItemTpl">
  <div class="d-flex align-items-center py-2 border-bottom">
    <div style="width:64px; height:48px; overflow:hidden;" class="me-3">
      <img class="img-fluid" style="object-fit:cover; width:100%; height:100%;" src="" alt="">
    </div>
    <div class="flex-grow-1">
      <div class="fw-semibold item-title"></div>
      <div class="small text-muted item-meta"></div>
    </div>
    <div class="text-end ms-3">
      <div class="fw-semibold item-subtotal"></div>
      <div class="small text-muted">x <span class="item-qty"></span></div>
    </div>
  </div>
</template>

<script>
  const fmt = (v) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(v);

  async function fetchJson(url, opts){
    const r = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts));
    if (r.status === 401) { window.location.href = '/login'; throw new Error('Unauthorized'); }
    if (!r.ok) throw new Error('Request failed ' + r.status);
    return r.json();
  }

  async function loadOrder(){
    const container = document.getElementById('orderContainer');
    container.innerHTML = '<div class="text-center py-5 text-muted">Cargando orden...</div>';
    try{
      const parts = (window.location.pathname || '').split('/');
      const id = parts[parts.length-1];
      if (!id) { container.innerHTML = '<div class="text-center py-5 text-muted">ID inválido.</div>'; return; }
      const order = await fetchJson(`/api/orders/${id}`);
      if (!order){ container.innerHTML = '<div class="text-center py-5 text-muted">Orden no encontrada.</div>'; return; }

      container.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'mb-3';
      header.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><h5>Orden ${order._id}</h5><div class="small text-muted">Código: ${order.code || ''}</div></div><div class="text-end"><div class="fw-semibold">Total: ${fmt(order.amount || 0)}</div><div class="small text-muted">${new Date(order.purchase_datetime || order.createdAt || order.updatedAt).toLocaleString()}</div></div></div>`;
      container.appendChild(header);

      const tpl = document.getElementById('orderItemTpl');
      for (const it of order.items || []){
        const clone = tpl.content.cloneNode(true);
        clone.querySelector('img').src = it.thumbnail || 'https://via.placeholder.com/300x200?text=Sin+imagen';
        clone.querySelector('.item-title').textContent = it.title || '';
        clone.querySelector('.item-meta').textContent = '';
        clone.querySelector('.item-subtotal').textContent = fmt(it.subtotal || 0);
        clone.querySelector('.item-qty').textContent = it.quantity || 0;
        container.appendChild(clone);
      }

    }catch(err){
      console.error(err);
      container.innerHTML = '<div class="text-center py-5 text-danger">Error cargando orden.</div>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadOrder);
</script>
